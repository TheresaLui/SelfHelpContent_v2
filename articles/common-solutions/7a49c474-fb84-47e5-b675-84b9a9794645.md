<properties
  pagetitle="Issue or errors in package execution"
  description=""
  service="microsoft.sqlvirtualmachine"
  resource="sqlvirtualmachines"
  ms.author="hecepeda"
  selfhelptype="Generic"
  supporttopicids="32749439"
  productpesids="14745"
  cloudenvironments="public, fairfax, mooncake, blackforest, ussec, usnat"
  disableclouds=""
  articleid="7a49c474-fb84-47e5-b675-84b9a9794645"
  ownershipid="AzureData_AzureSQLVM" />
# Issue or errors in package execution

The execution of an SSIS package may fail due to multiple reasons. We will discuss a few of the reasons in brief.

### __Missing Windows Privileges and Rights__

The Service Accounts running SSIS Service, SQL Server Agent Service and SQL Server Agent Service require some privileges at the Operating System level to be able to execute SSIS packages. Without these permissions deployment of an SSIS package to SSISDB Catalog, execution of an SSIS package located in SSISDB Catalog and execution of an SSIS package via SQL Server Agent job may get impacted.

A few errors users may face if these privileges are missing:

- **Error**: System.ComponentModel.Win32Exception: *A required privilege is not held by the client while Deploying SSIS Project.*
- **Error**: The process could not be created for step 1 of job (reason: *A required privilege is not held by the client*). The step failed.
- Packages in SSISDB Catalog could be stuck in ‘Pending Execution’ state.

**To confirm** that the issue is happening because of missing privileges and rights, one can deploy a package to file system and execute it via **DTExec**.

The below **privileges** are **required by SSIS, SQL Server and SQL Server Agent** service accounts:

_SQL Server Database Engine_:
Log on as a service (**SeServiceLogonRight**)
Replace a process-level token (**SeAssignPrimaryTokenPrivilege**)
Bypass traverse checking (**SeChangeNotifyPrivilege**)
Adjust memory quotas for a process (**SeIncreaseQuotaPrivilege**)

_SQL Server Agent_:
Log on as a service (**SeServiceLogonRight**)
Replace a process-level token (**SeAssignPrimaryTokenPrivilege**)
Bypass traverse checking (**SeChangeNotifyPrivilege**)
Adjust memory quotas for a process (**SeIncreaseQuotaPrivilege**)

_SSIS_:
Log on as a service (**SeServiceLogonRight**)
Permission to write to application event log.
Bypass traverse checking (**SeChangeNotifyPrivilege**)
Impersonate a client after authentication (**SeImpersonatePrivilege**)

One can adjust these properties under **Run**-> _Secpol.msc_ -> User Rights Assignment

## **Recommended Documents**

[Required privileges and rights for SQL Server Services](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions?view=sql-server-ver15#Serv_Perm)

[The following article discusses a similar issue](https://techcommunity.microsoft.com/t5/sql-server-support/system-componentmodel-win32exception-a-required-privilege-is-not/ba-p/317804)

### **Memory related issues**

The execution of an SSIS Package may fail with different errors suggesting the issue is memory related.

A few memory related errors for SSIS Packages are listed below:

- _Not enough storage is available to complete this operation._

- _A buffer failed while allocating 10485760 bytes._

- _The system reports 2 percent memory load. There are 1,099,441,074,176 bytes of physical memory with 1074776596480 bytes free. There are 4294836224 bytes of virtual memory with 65310720 bytes free. The paging file has 1153128165376 bytes with 1124943544320 bytes free._

- _The attempt to add a row to the Data Flow task buffer failed with error code **0x8007000E.**_

If an SSIS Package fails due to memory related issues, please ensure that best practices for SSIS Package development have been followed. You can refer to the below links:

[Data flow performance features](https://docs.microsoft.com/sql/integration-services/data-flow/data-flow-performance-features?view=sql-server-ver15)
[Tutorial SSIS performance videos](https://techcommunity.microsoft.com/t5/sql-server-integration-services/tutorial-ssis-performance-videos/ba-p/387581)

## **Recommended Steps**

- If possible, try executing the package in **64-bit**.
- If SSIS Package is running on the same machine as SQL Server and if SQL Server is consuming most of the memory, **try reducing the memory cap for SQL Server** or **try executing the SSIS Package on another machine**.
- Sometimes 3rd party components\drivers (for instance some versions of Oracle OLEDB driver) are known to cause memory leak issues. One can **try to isolate the issue by removing the 3rd party components** from the package for a test run.

### **Account related issues**

In some cases, a package might run in Visual Studio SSDT and the **execution would fail** post deployment with a **different account**.

1. Please ensure if the package is failing due to **permission differences between the two accounts** by executing the package with the **same account which was used to execute it on Visual Studio SSDT**.
2. If the Package executes successfully under one account and fails under another, then **one of the accounts is missing a required privilege** (could be a privilege for a network share\for a connection or a right\privilege on the OS level).

How to **run an SSIS Package** under a **different account** via SQL Server Agent Job?
For SQL Server Agent Jobs, an SSIS Package can be executed by an account other than the SQL Agent Service Account by using a **proxy account**. Please refer to the below documentation to understand the concept of proxies in SQL Agent:

- [Creating a SQL Server Agent Proxy](https://docs.microsoft.com/sql/ssms/agent/create-a-sql-server-agent-proxy?view=sql-server-ver15)
- [Using SQL Server Agent Proxy for an SSIS Package](https://docs.microsoft.com/sql/integration-services/packages/sql-server-agent-jobs-for-packages?view=sql-server-ver15#to-automate-package-execution-by-using-sql-server-agent)
- [Issues with running an SSIS Package using SQL Server Agent Service Account](https://docs.microsoft.com/troubleshoot/sql/integration-services/ssis-package-doesnt-run-when-called-job-step)

### **Connection related issues**

One of the most common issues which prevent an SSIS package from getting executed successfully are issues with data source connections.

Connection to a data source can fail in validation phase or in execution phase.
If a connection fails in validation phase, then it is either due to a design issue in package or an issue with connectivity to the data source. 

### Recommendations

- If a connection works during the design phase but fails when the package is executed, try to hardcode the connection properties (connection string, username, password etc.) if the connection manager was parameterized to determine if there is an issue with parameterization.

- Sometimes, it is necessary to determine if one can connect to the data source outside SSIS using the same driver or not.

- Below we have discussed how one can test connectivity to OLEDB and ODBC data sources outside SSIS.

#### Issues with OLEDB Connections:

One of the most used connections in SSIS are OLEDB Connections. One can use an OLEDB Source\Destination adapter and connect to any OLEDB data source (for example SQL Server, Microsoft Excel, Oracle DB etc.), provided the required OLEDB Provider is installed on the machine.

To test connectivity to an OLEDB Source, follow the below steps:

1. Create a **new text file** and open it in **notepad**.
2. Go to File->**Save As**.
3. Change the Save As Type to **“All Files (*.*)”**.
4. Name the files as **“UDL.udl”**.
5. Save the file.
6. Open the UDL file we just saved.
7. Go to the first tab and choose the **OLEDB Provider** being used in SSIS package in the OLEDB Connection Manager and click on the **Connection** tab.
8. Enter the connection details and **test connection**.
9. If the connection fails, there’s an issue with connectivity to the data source.

#### Issues with ODBC Connections:

Another heavily used connection type is ODBC Connection which can be used to connect to a variety of data sources via their respective ODBC drivers.
To test connectivity to an ODBC data source, follow the below steps:

  **Note:** **Visual Studio SSDT is a 32-bit tool** and requires 32-bit drivers to establish connections in design time. **During runtime, one can use 64-bit** drivers as well.

1. Search for ODBC Data Sources (choose 64-bit or 32-bit depending on whether the package needs to be executed in 32-bit or 64-bit) and open it. 
2. In ODBC Data Source Administrator window, click on **System DSN** tab and click on **Add**.
3. Choose the driver which is being used within the SSIS package in ODBC Connection and click on **Finish**.
4. The following window and options would vary for different drivers. Fill the data source details and **test connection**.
5. If the connection fails, there’s an issue with connectivity to the data source.

#### Issues with OData Connections:

Please note that **OData does not support MFA and Modern Authentication** in Odata Connection Manager.

- [Supported Authentication Types](https://docs.microsoft.com/sql/integration-services/connection-manager/odata-connection-manager?view=sql-server-ver15#connection-manager-authentication)
- If you want to [enforce connections over TLS 1.2](https://techcommunity.microsoft.com/t5/sql-server-support/tls-issue-with-ssis-package-while-accessing-odata-source-like/ba-p/319077)

**Note:** Intermittent connection issues and connection drops in midst of an execution (some of the probable causes being a fault in the network, server performance etc.) are not covered here.