<properties
  pagetitle="Azure Migrate: Server Migration replication issues"
  service="microsoft.migrate"
  resource="migrateprojects"
  ms.author="anvar"
  selfhelptype="Generic"
  supporttopicids="32755173"
  resourcetags=""
  productpesids="16348"
  cloudenvironments="public,fairfax,mooncake,blackforest,ussec,usnat"
  articleid="83fd6ec8-f748-4ab2-9872-4286613515b5"
  ownershipid="Compute_AzureMigrate" />
# Azure Migrate: Server Migration replication issues

## **Agentless replication of VMware virtual machines**
The following is a list of common replication issues and their solutions. 

**Start replication fails with the following error:**
* "Deployment validation failed with multiple errors: 'Authentication failed for template resource migratelsa****/...'"

   Azure Migrate creates a Key Vault to manage access keys to the replication storage account in your subscription. To create the vault, you set permissions (Owner, or Contributor and User Access Administrator) on the resource group in which the Azure Migrate project resides.

**Start replication fails with a Key Vault operation error:**
* "Key Vault operation failed. Operation is Configure managed storage account."
* "Key Vault operation failed. Operation is Generate shared access signature definition."

  These errors happen if the logged-in user doesn't have the necessary permissions to configure storage accounts to be managed by the Key Vault. You can give yourself the necessary Key vault permissions by using the following PowerShell snippet:

```
$userPrincipalId = $(Get-AzureRmADUser -UserPrincipalName "loggedinuser").Id
Set-AzureRmKeyVaultAccessPolicy -VaultName "keyvaultname" -ObjectId $userPrincipalId -PermissionsToStorage get, list, delete, set, update, regeneratekey, getsas, listsas, deletesas, setsas, recover, backup, restore, purge
```

**I can't change the name of the VM before I start replication**

If you want to change the name of the VM, select the VM and start replication. Once initial replication is complete, click on the VM, go to Compute and Network blade, change the name of the VM to the desired name, and click save. 

**Replication is stuck at 0%**

If there are multiple VMs that are replicating, initial replication for the VMs will be sequenced in batches. Initial replication may seem to be stuck at 0% for VMs that are sequenced behind others. Check replication events for the VM to see if there are any errors. If there are no errors, wait for initial replication for the other VMs to complete.


**Bandwidth throttling for replication**

You can control the bandwidth used by the Azure Migrate appliance for replication using [Windows NetQosPolicy](https://go.microsoft.com/fwlink/?linkid=2137869)


**Replication cycle failed with error "No disk snapshots were found for snapshot replication"**

This error occurs when a storage vMotion happens on a virtual machine under replication. Storage vMotion of a virtual machine under replication is currently not supported.

- Storage vMotion the virtual machine back to its original datastore to allow subsequent replication cycles to proceed
- Else, stop replication for the virtual machine and configure replication again. This is equivalent to a fresh replication of the virtual machine after the storage vMotion.

If your issue is not listed here, follow the [troubleshooting article here](https://go.microsoft.com/fwlink/?linkid=2143853).


**VMware support matrix** | **Details**
--- | ---
**VMware vCenter Server** | Version 5.5, 6.0, 6.5, 6.7, 7.0.
**VMware vSphere ESXI host** | Version 5.5, 6.0, 6.5, 6.7, 7.0.

**vCenter Server permissions** 
 
Agentless migration uses the Azure Migrate appliance. The appliance needs these permissions in vCenter Server:
 - **Datastore.Browse** (Datastore -> Browse datastore): Allow browsing of VM log files to troubleshoot snapshot creation and deletion.
 - **Datastore.FileManagement** (Datastore -> Low level file operations): Allow read/write/delete/rename operations in the datastore browser, to troubleshoot snapshot creation and deletion.
 - **VirtualMachine.Config.ChangeTracking** (Virtual machine -> Disk change tracking): Allow enable or disable change tracking of VM disks, to pull changed blocks of data between snapshots.
 - **VirtualMachine.Config.DiskLease** (Virtual machine -> Disk lease): Allow disk lease operations for a VM, to read the disk using the VMware vSphere Virtual Disk Development Kit (VDDK).
 - **VirtualMachine.Provisioning.DiskAccess**: (specifically for vSphere 6.0 and above) Allow opening a disk on a VM for random read access on the disk using the VDDK. 
 - **VirtualMachine.Provisioning.DiskRandomRead** (Virtual machine -> Provisioning -> Allow read-only disk access): Allow opening a disk on a VM, to read the disk using the VDDK.
 - **VirtualMachine.Provisioning.DiskRandomAccess** (Virtual machine -> Provisioning -> Allow disk access): Allow opening a disk on a VM, to read the disk using the VDDK.
 - **VirtualMachine.Provisioning.GetVmFiles** (Virtual machine -> Provisioning -> Allow virtual machine download): Allows read operations on files associated with a VM, to download the logs and troubleshoot if failure occurs
 - **VirtualMachine.State.\*** (Virtual machine -> Snapshot management): Allow creation and management of VM snapshots for replication.
 - **VirtualMachine.Interact.PowerOff** (Virtual machine -> Interaction -> Power off): Allow the VM to be powered off during migration to Azure.