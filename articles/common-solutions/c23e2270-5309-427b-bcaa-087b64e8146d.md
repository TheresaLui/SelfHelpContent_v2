<properties
  pagetitle="Cannot Connect to SQL Instance"
  service="microsoft.sqlvirtualmachine"
  resource="sqlvirtualmachines"
  ms.author="ujpat"
  selfhelptype="Generic"
  supporttopicids="32740109"
  productpesids="14745,16342"
  cloudenvironments="public, fairfax, mooncake, blackforest, ussec, usnat"
  articleid="c23e2270-5309-427b-bcaa-087b64e8146d"
  ownershipid="AzureData_AzureSQLVM" />
# Cannot Connect to SQL Instance

Most users can resolve their SQL connectivity issues by using the following information.

## **Recommended Steps**

- **Most Common Errors**

  * **Error:"Cannot Generate SSPI Context"** while connecting to SQL Server

     Connectivity to SQL Server may fail because of SPN duplication, or incorrectly registered or missing entries. Download and [run Kerberos Configuration Manager](https://www.microsoft.com/download/details.aspx?id=39046) to fix these SPN issues.

  * **SQL Service does not Start because of missing TempDB folders**

     If you restarted your VM or resized your VM, SQL may not start because of Tempdb files or folders missing on the D drive. We are working on a fix for this. 
     
     Run the following script, which creates the TempDB structure:
    
    ```PS
      $SQLService="SQL Server (MSSQLSERVER)"
      $SQLAgentService="SQL Server Agent (MSSQLSERVER)"
      $tempfolder="D:\tempDB\Data"
      $logfolder="D:\tempDB\Log"
      if (!(test-path -path $tempfolder))
       {    
       New-Item -ItemType directory -Path $logfolder  
       New-Item -ItemType directory -Path $tempfolder
       }
       Start-Service $SQLService 
       Start-Service $SQLAgentService
      ````

   * **Login fails for the account "NT SERVICE\\SqlIaaSExtensionQuery"**

     Uninstalling and [reinstalling Resource provider](https://docs.microsoft.com/azure/azure-sql/virtual-machines/windows/sql-vm-resource-provider-register?tabs=bash%2Cazure-cli#lightweight-management-mode) can fix the issue. Installing full management mode for Resource provider requires a SQL Service restart. Make sure you have this as a login in your SQL Server, or run:
     
     ```SQL
      CREATE LOGIN [NT Service\SQLIaaSExtensionQuery] FROM WINDOWS WITH DEFAULT_DATABASE=[master]
      GO
      ALTER SERVER ROLE [sysadmin] ADD MEMBER [NT Service\SQLIaaSExtensionQuery]
      GO
      ```

  *   **Azure Active Directory authentication/connectivity is not supported with Azure SQL VM**

      SQL Server on Azure VM supports Windows Authentication and SQL Authentication. [Learn more]( https://docs.microsoft.com/azure/azure-sql/database/authentication-aad-overview).

   * **I forgot sysadmin (sa) password. How do I log in to SQL Server instance?** 

     For a VM deployed with the SQL Server marketplace image, the VM administrator account that you initially created when you first deployed the VM, by default, has sysadmin access to SQL instance. If you have not removed that administrator account from SQL instance, you can remote desktop in using the original administrator account to access the SQL instance. If you have forgotten original VM administrator account password, you can [reset it](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/reset-rdp?WT.mc_id=Portal-Microsoft_Azure_Support).

- **Diagnosis and mitigation action steps**

    * If you are having issues connecting to SQL Server Instance on Azure VM from a different network or on premises, see [ways to connect to SQL](https://docs.microsoft.com/azure/azure-sql/virtual-machines/windows/ways-to-connect-to-sql).

   * Make sure that the port used by SQL Server (1433) is open for inbound/outbound connections. You can [telnet](https://docs.microsoft.com/windows-server/administration/windows-commands/telnet) to the port or use [Test-NetConnection](https://docs.microsoft.com/powershell/module/nettcpip/test-netconnection?view=win10-ps#example-3--test-tcp-connectivity-and-display-detailed-results) to check if the port is blocked at **NSG or Windows Firewall**. Make sure your company firewall is not blocking these connections by checking with your network admin. An outbound rule from where you make a connection has to be added for the SQL port to Windows Firewall and the company firewall.  

  * You may see intermittent connectivity issues to SQL instance if your AG failed over and does not come online due to [lease timeout](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/availability-group-lease-healthcheck-timeout?view=sql-server-ver15#updating-cluster-and-always-on-timeout-values), or if you are having issues with [SQL Performance](https://docs.microsoft.com/azure/azure-sql/virtual-machines/windows/performance-guidelines-best-practices), network issues, or [Disk or VM Throttling](https://docs.microsoft.com/azure/virtual-machines/windows/disk-performance-windows). Check the SQL error log to find out more.

   * Make sure TCP/IP and shared memory in [SQL server configuration are enabled](https://docs.microsoft.com/sql/database-engine/configure-windows/enable-or-disable-a-server-network-protocol?view=sql-server-ver15#SSMSProcedure).

## **Recommended Documents**

* [Solving Connectivity errors to SQL Server](https://support.microsoft.com/help/4009936/solving-connectivity-errors-to-sql-server)
* [Applications experience forcibly closed TLS connection errors](https://docs.microsoft.com/troubleshoot/windows-server/identity/apps-forcibly-closed-tls-connection-errors) * [Upgrade to TLS 1.2 for Secure Communication](https://support.microsoft.com/help/3135244/kb3135244-tls-1-2-support-for-microsoft-sql-server)
* [Connect to a SQL Server Virtual Machine on Azure VM](https://docs.microsoft.com/azure/azure-sql/virtual-machines/windows/ways-to-connect-to-sql)
