<properties
  pagetitle="Connection to Availability Group, FCI or Listener"
  service="microsoft.sqlvirtualmachine"
  resource="sqlvirtualmachines"
  ms.author="ujpat"
  selfhelptype="Generic"
  supporttopicids="32782254"
  productpesids="14745,16342"
  cloudenvironments="public, fairfax, mooncake, blackforest, ussec, usnat"
  articleid="9c4a0eac-e594-454c-9c66-8136a48c8067"
  ownershipid="AzureData_AzureSQLVM" />
# Connection to Availability Group, FCI or Listener

Most users can resolve their SQL Listener Connectivity issues by using the following steps.

## **Recommended Steps**

1. On Azure virtual machines, a SQL Server Availability Group requires a Load Balancer to be configured correctly. Otherwise, Listener connectivity may fail. Check the [Load balancer Configuration](https://docs.microsoft.com/azure/azure-sql/virtual-machines/windows/availability-group-manually-configure-tutorial#create-an-azure-load-balancer).
2. Make sure **Floating IP** is enabled when you configure the Load Balancing Rule.
3. Check **Ports 1433** (SQL Instance Port), **5022** (Mirroring Endpoint), and **59999** (Probe Port). You can [telnet](https://docs.microsoft.com/windows-server/administration/windows-commands/telnet) to the port or use [Test-NetConnection](https://docs.microsoft.com/powershell/module/nettcpip/test-netconnection?view=win10-ps#example-3--test-tcp-connectivity-and-display-detailed-results) to check that they are not blocked at **NSG or Windows Firewall**. 
4. Make sure SQL instance is not using [Dynamic Ports](https://docs.microsoft.com/sql/tools/configuration-manager/tcp-ip-properties-ip-addresses-tab?view=sql-server-ver15#dynamic-ports).
5. Check that you provided the correct values when you [run PowerShell](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial#configure-listener), as shown in the following script:
    
     ```
     $ClusterNetworkName = "<MyClusterNetworkName>" # the cluster network name (Use Get-ClusterNetwork on Windows Server 2012 of 
     higher to find the name)
     $IPResourceName = "<IPResourceName>" # the IP Address resource name
     $ListenerILBIP = "<n.n.n.n>" # the IP Address of the Internal Load Balancer (ILB). This is the static IP address for the load 
     balancer you configured in the Azure portal.
     [int]$ListenerProbePort = <nnnnn>

     Import-Module FailoverClusters
     Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple 
     @{"Address"="$ListenerILBIP";"ProbePort"=$ListenerProbePort;"SubnetMask"="255.255.255.255";
     "Network"="$ClusterNetworkName";"EnableDhcp"=0}
     ```
     
     **NOTE**: After you run the PowerShell to configure the cluster parameters, you must take the AG resource offline, and then online again, to ensure that modifications        take effect. Run PowerShell on one node (VM) of the cluster only.
       
6. If you are connecting outside from a different network or on-premises, make sure that your company firewall is not blocking these connections. Check with your **Network Admin**.
7. Make sure your instance is enabled for TCP/IP Communication and has the [Listen All](https://docs.microsoft.com/sql/tools/configuration-manager/tcp-ip-properties-ip-addresses-tab?view=sql-server-ver15#options) property set. Make sure the browser service is running.
8. If you cannot connect to Listener, try to connect by using SSMS with various combinations such as `Listener name, Port` or `Listener IP, Port` to make sure you aren't having DNS name resolution issues. Check on DNS Server that the record for the Listener still exists and is pointing to the correct IP Address.
9. You may see issues connecting to Listener if your AG failed over and does not come online due to [Lease Timeout](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/availability-group-lease-healthcheck-timeout?view=sql-server-ver15#updating-cluster-and-always-on-timeout-values), or if you are having issues with [SQL Performance](https://docs.microsoft.com/azure/azure-sql/virtual-machines/windows/performance-guidelines-best-practices) or [Disk or VM Throttling](https://docs.microsoft.com/azure/virtual-machines/windows/disk-performance-windows). Check the SQL Error log to find out more.
10. If Create Listener fails with Message 19471, "The WSFC cluster could not bring the Network Name resource online," [follow these instructions](https://docs.microsoft.com/archive/blogs/alwaysonpro/create-listener-fails-with-message-the-wsfc-cluster-could-not-bring-the-network-name-resource-online).
  
## **Recommended Documents**

* [Configure Load Balancer and Listener Correctly](https://docs.microsoft.com/azure/azure-sql/virtual-machines/windows/availability-group-manually-configure-tutorial#create-an-azure-load-balancer)
* [Configure load balancer for AG VNN listener](https://docs.microsoft.com/azure/azure-sql/virtual-machines/windows/availability-group-vnn-azure-load-balancer-configure)
