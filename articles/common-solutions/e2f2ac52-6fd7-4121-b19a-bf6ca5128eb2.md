<properties
  pagetitle="This is the title of the article. It is not displayed in the portal but is a required part of every article."
  description=""
  service="microsoft.keyvault"
  resource="managedhsms"
  ms.author="qinx"
  selfhelptype="Generic"
  supporttopicids="32736894,32736895,32736896,32736897,32736898,32736900,32736904,32736906,32736907,32736915,32736916"
  productpesids="17075"
  cloudenvironments="public"
  disableclouds="blackforest,fairfax,mooncake,usnat,ussec"
  articleid="e2f2ac52-6fd7-4121-b19a-bf6ca5128eb2"
  ownershipid="AzureKeyVault_MHSM" />
# This is the title of the article. It is not displayed in the portal but is a required part of every article.

An application(s) does not have sufficient permissions to perform operations on '<!--$PoolName-->[PoolName]<!--/$PoolName-->' Managed HSM.

## **Recommended Steps**

We have run a diagnostics in our logs and identified that operation **<!--ActivityName-->[ActivityName]<!--/ActivityName-->** of an application with service principal id '**<!--CallerId-->[CallerId]<!--/CallerId-->**' was denied at around <!--ActivityTime-->[ActivityTime]<!--/ActivityTime--> UTC between problem start time <!--ProblemStartTime-->[ProblemStartTime]<!--/ProblemStartTime--> UTC and <!--CaseCreationTime-->[CaseCreationTime]<!--/CaseCreationTime--> UTC.   

To solve this problem, 

1. Make sure this service principal is the one used in your application. The CLI command below can show the information about this service principal.
  ```
  az ad sp show --id "<!--CallerId-->[CallerId]<!--/CallerId-->" 
  ```

2. If this is a trusted application, ask an administrator ( a user in Managed HSM builtin roles "Managed HSM Administor" ) of Managed HSM '**<!--PoolName-->[PoolName]<!--/PoolName-->**' to assign a appropriate role to the application with service principal id '**<!--CallerId-->[CallerId]<!--/CallerId-->**'.
 
  For example when using Azure CLI, run this command as the administrator of the Managed HSM '<!--PoolName-->[PoolName]<!--/PoolName-->':<br>
  - To give key encrypt/decrypt operations to the application:
    ```
    az keyvault role assignment create --assignee "<!--CallerId-->[CallerId]<!--/CallerId-->" --role "Managed HSM Crypto User" --scope "/" --hsm-name <!--PoolName-->[PoolName]<!--/PoolName-->
    ```

  - To give key additional key create/delete operations to the application: 

    ```
    az keyvault role assignment create --assignee "<!--CallerId-->[CallerId]<!--/CallerId-->" --role "Managed HSM Crypto Officer" --scope "/" --hsm-name <!--PoolName-->[PoolName]<!--/PoolName-->
    ```

  Role "Managed HSM Administrator" has all the permissions.

  To list all the administorators of this Managed HSM, run Azure CLI command:
  ```
  az keyvault role assignment list --hsm-name <!--PoolName-->[PoolName]<!--/PoolName--> --role "Managed HSM Administrator"
  ```

  See links below for details of different builtin roles' permissions in Managed HSM.

## **Recommended Documents**

Refer to the following documents to setup permissions for your application.<br>

* [Managed HSM local RBAC built-in roles](https://docs.microsoft.com/azure/key-vault/managed-hsm/built-in-roles)
* [Managed HSM access control](https://docs.microsoft.com/azure/key-vault/managed-hsm/access-control)

### Notes

* The **Recommended Steps** and **Recommended Documents** headings must be entered as shown above (bolded H2)
* Formatting is not identical to Microsoft Docs - tables do not work, nor [!NOTE] tags
* Your Recommended Steps should be actual steps, not just links to other articles
* Ensure all links to Microsoft docs are non-region-specific, i.e. does not include /en-us/. This does not apply to articles for Mooncake.
* Don't link to internal review documentation - these URLs always start with "review.microsoft.docs", and users are unable to access them
* Do not use aka.ms links
* Copy the raw form of this article to use as a template for your own Common Solution article. Be sure to fill in the metadata!