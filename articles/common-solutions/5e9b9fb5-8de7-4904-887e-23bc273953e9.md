<properties
  pagetitle="Database mail  "
  description=""
  service="microsoft.sqlvirtualmachine"
  resource="sqlvirtualmachines"
  ms.author="ujpat"
  selfhelptype="Resource"
  supporttopicids="32788718"
  productpesids="14745,16342"
  cloudenvironments="public, fairfax, mooncake, blackforest, ussec, usnat"
  disableclouds=""
  articleid="5e9b9fb5-8de7-4904-887e-23bc273953e9"
  ownershipid="AzureData_AzureSQLVM" />
# Database mail  

4 out of 5 customers are able to resolve their issues with ‘Database mail’ using the following steps.

## **Recommended Steps**

* **Recommended method of sending email**
   - Use authenticated SMTP relay services to send email from Azure VMs or from Azure App Service. 
   - These relay services typically connect through TCP port 587, but they support other ports.) 
   - [SendGrid](https://sendgrid.com/partners/azure/) is one such SMTP relay service, but there are others. 
   - You might also have a secure SMTP relay service running on-premises that you can use.

* **Troubleshooting database mail issues**

   - Check if 'Database Mail XPs' option enabled in sys.configurations view. If not, you can enable it using the following script:

       ```
       sp_configure 'show advanced options', 1;  
       GO  
       RECONFIGURE;  
       GO  
       sp_configure 'Database Mail XPs', 1;  
       GO  
       RECONFIGURE  
       GO
       ```
  
   - Check have you **correctly configured an email profile** with a correct email server name/IP address, port and account information (username and password)
       - Check if you can **reach the mail server** from SQL VM.
       - Check in the Network Security Group associated to the subnet where your database mail server is placed do you have inbound rule that allows communication via **TCP port 25.**
       - **Check in the Network Security Group** associated to the SQL VM subnet do you do have outbound rule that allows communication via TCP port 25
       - Make sure that subnet range where your SQL VM is placed is configured as allowed sender in your target mail server. 
       - If you are using custom DNS for mail server make sure you update Azure DNS with the DNS record of the mail server.
       - Create a SQL Agent job that has one PowerShell task that executes command like `tns smtp.sendgrid.net -25`, run the job and check the job output in the job history. 
       - Replace the name of the mail server and/or port in the job with the mail server and port that you are using and repeat the previous step.
  - Check have you **enabled the port** that is used to communicate with the email server; the port should be added in the [Outbound security rules](https://docs.microsoft.com/azure/virtual-network/tutorial-filter-network-traffic#create-security-rules)
  - **Check the status of EMail messages** sent with database mail in Database Mail Log, msdb.dbo.sysmail_event_log, and msdb.dbo.sysmail_faileditems.



## **Recommended Documents**

- [Troubleshooting Database Mail](https://docs.microsoft.com/previous-versions/sql/sql-server-2008-r2/ms188663(v=sql.105)) 
- [Send Email Using SendGrid with Azure](https://docs.microsoft.com/azure/sendgrid-dotnet-how-to-send-email) 
- [Configure Database Mail](https://docs.microsoft.com/sql/relational-databases/database-mail/configure-database-mail?view=sql-server-ver15&WT.mc_id=Portal-Microsoft_Azure_Support) 
- [Troubleshoot outbound SMTP connectivity problems in Azure](https://docs.microsoft.com/azure/virtual-network/troubleshoot-outbound-smtp-connectivity)